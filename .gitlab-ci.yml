stages:
    - build
    - test
    - docs
    - report

variables:
  CONDA_ENV: "freva-dev"
  PYTHON_VERSION: "3.10"
  FREVA_ENV: "/tmp/freva/bin"
  EVALUATION_SYSTEM_CONFIG_FILE: ".docker/evaluation_system.conf"

lint:
  image: continuumio/anaconda3
  stage: build
  tags:
    - docker, specific
  before_script:
    - conda env create -q -f dev-environment.yml
    - apt update && apt install make
  script:
    - conda run -n $CONDA_ENV make lint

dev-obs:
    stage: build
    image:
        name: gcr.io/kaniko-project/executor:debug
        entrypoint: [""]
    script:
        - if [ -n "$CI_COMMIT_BRANCH" ]; then IMAGETAG="$CI_COMMIT_BRANCH"; else IMAGETAG="$CI_COMMIT_SHA"; fi
        - echo $CI_COMMIT_BRANCH
        - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
        - /kaniko/executor --context $CI_PROJECT_DIR
                       --cleanup
                       --skip-unused-stages=true
                       --build-arg=CI_REGISTRY_IMAGE=${CI_REGISTRY_IMAGE}
                       --build-arg=IMAGETAG=${IMAGETAG}
                       --build-arg=branch=${CI_COMMIT_BRANCH}
                       --build-arg=binder="false"
                       --whitelist-var-run=false
                       --dockerfile $CI_PROJECT_DIR/Dockerfile
                       --destination $CI_REGISTRY_IMAGE/freva_build:$CI_COMMIT_BRANCH
    tags:
        - docker, specific
    rules:
        - if: "$CI_COMMIT_BRANCH == 'master'"
        - if: "$CI_COMMIT_BRANCH != 'master'"

.test_template: &py_test # pytest framework template
    stage: test
    image: registry.gitlab.dkrz.de/freva/evaluation_system/freva_build:$CI_COMMIT_BRANCH
    variables:
      CONDA: "Miniconda3-latest"
    tags:
      - docker, specific

test_37:
    << : *py_test
    variables:
      PYTHON_VERSION: "3.7"
    script:
        # Do the unit tests
      - python3 deploy.py /tmp/freva -e -s --run_tests --packages gitpython pandoc

test_38:
    << : *py_test
    variables:
      PYTHON_VERSION: "3.8"
    script:
        # Do the unit tests
      - python3 deploy.py /tmp/freva -e -s --run_tests --packages gitpython pandoc

test_39:
    << : *py_test
    variables:
      PYTHON_VERSION: "3.8"
    script:
        # Do the unit tests
      - python3 deploy.py /tmp/freva -e -s --run_tests --packages gitpython pandoc

test_latest:
    << : *py_test
    script:
      # Install the conda env
      - python3 deploy.py /tmp/freva -e -s --packages gitpython pandoc
      # Do the unit tests with converage reports
      - make test_coverage
    artifacts:
      when: always
      reports:
        junit: report.xml
      paths:
        - coverage_report
        - test_results
        - report.xml

docs:
    << : *py_test
    variables:
      EVALUATION_SYSTEM_PLUGINS: "src/evaluation_system/tests/mocks,dummy:/tmp/animator,animator"
      EVALUATION_SYSTEM_CONFIG_FILE: "compose/local-eval-system.conf"
      FREVA_ENV: "/tmp/freva/bin"
    before_script:
      - python3 deploy.py /tmp/freva -e -s --packages gitpython pandoc cartopy xarray dask cftime
      - /tmp/freva/bin/python3 -m pip install .[docs]
      - git clone --recursive https://gitlab.dkrz.de/freva/plugins4freva/animator.git /tmp/animator
      - /tmp/freva/bin/python3 -m ipykernel install --user --name freva
    script:
      - /tmp/freva/bin/freva plugin animator project=observations variable=pr; echo 0
      - make dummy-data
      - make docs
    after_script:
      mv docs/_build/html sphinx_docs
    artifacts:
      when: always
      paths:
        - public

pages:
  stage: report
  image: registry.gitlab.dkrz.de/freva/evaluation_system/freva_build:$CI_COMMIT_BRANCH
  tags:
    - docker, specific
  dependencies:
    - test_latest
    - docs
  before_script:
    - mkdir -p public; cp .docker/index.html public/
    - mv coverage_report public/
  script:
    - /opt/allure/bin/allure generate --clean test_results
  after_script:
    - mv allure-report public/
    - mv sphinx_docs public/
  artifacts:
    when: always
    paths:
      - public/
    reports:
      junit: report.xml
